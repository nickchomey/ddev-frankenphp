#ddev-generated

ADD ./Caddyfile.frankenphp /etc/frankenphp/Caddyfile

RUN <<EOF
set -eu -o pipefail

# Copy standard PHP configuration to php-zts location
cp /etc/php/${DDEV_PHP_VERSION}/fpm/php.ini /etc/php-zts/php.ini
update-alternatives --install /usr/bin/php php /usr/bin/php-zts 50
update-alternatives --set php /usr/bin/php-zts

# Patch start.sh to use php-zts paths
sed -i 's|/usr/bin/php${DDEV_PHP_VERSION}|/usr/bin/php-zts|g' /start.sh
sed -i 's|/etc/php/${DDEV_PHP_VERSION}/fpm/conf.d/|/etc/php-zts/conf.d/|g' /start.sh

# Copy DDEV PHP module configurations to php-zts location
cp /etc/php/${DDEV_PHP_VERSION}/mods-available/assert.ini /etc/php-zts/conf.d/20-assert.ini
cp /etc/php/${DDEV_PHP_VERSION}/mods-available/blackfire.ini /etc/php-zts/conf.d/90-blackfire.ini

# Append DDEV extension configurations to existing php-zts ini files
for EXT_NAME in xdebug xhprof; do
    # Find the source extension ini file in mods-available
    EXT_SRC_INI=$(find "/etc/php/${DDEV_PHP_VERSION}/mods-available" -name "*${EXT_NAME}*.ini" -type f | head -n 1)
    if [ -z "$EXT_SRC_INI" ]; then
        echo "ERROR: ${EXT_NAME} ini file not found in /etc/php/${DDEV_PHP_VERSION}/mods-available" >&2
        exit 1
    fi

    # Find the destination extension ini file in php-zts conf.d
    EXT_ZTS_INI=$(find /etc/php-zts/conf.d -name "*${EXT_NAME}*.ini" -type f | head -n 1)
    if [ -z "$EXT_ZTS_INI" ]; then
        echo "ERROR: ${EXT_NAME} ini file not found in /etc/php-zts/conf.d" >&2
        exit 1
    fi

    # Append config from mods-available, excluding extension loading lines
    grep -v -E '^(zend_)?extension=' "$EXT_SRC_INI" >> "$EXT_ZTS_INI"
done

# Create symlinks for phpenmod and phpdismod to use php-zts versions
ln -sf /usr/sbin/phpenmod-zts /usr/sbin/phpenmod
ln -sf /usr/sbin/phpdismod-zts /usr/sbin/phpdismod

# Reconfigure blackfire-php if installed, to match the current PHP version
if dpkg -s blackfire-php >/dev/null 2>&1; then
    dpkg-reconfigure blackfire-php
fi

# We don't want these modules enabled by default
phpdismod assert blackfire xdebug xhprof

# Modify xdebug/xhprof enable/disable scripts to restart via supervisorctl
# This is needed only for DDEV versions prior to v1.25.0
scripts=(
    /usr/local/bin/enable_xdebug
    /usr/local/bin/disable_xdebug
    /usr/local/bin/enable_xhprof
    /usr/local/bin/disable_xhprof
)
for script_file in "${scripts[@]}"; do
    if ! grep -q "supervisorctl restart 'webextradaemons:*'" "$script_file"; then
        sed -i "s|killall -USR2 php-fpm|supervisorctl restart 'webextradaemons:*'|g" "$script_file"
    fi
done

# Ensure write permissions for all users on php-zts directories
chmod -fR ugo+w /etc/php-zts /var/lib/php-zts
EOF
