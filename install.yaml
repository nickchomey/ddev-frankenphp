name: frankenphp

project_files:
  - config.frankenphp.yaml
  - docker-compose.frankenphp.yaml
  - web-build/Caddyfile.frankenphp
  - web-build/Dockerfile.frankenphp
  - web-build/pre.Dockerfile.frankenphp

pre_install_actions:
  - |
    #ddev-description:Checking PHP version compatibility
    UNSUPPORTED_PHP_VERSIONS=("5.6" "7.0" "7.1" "7.2" "7.3" "7.4" "8.0" "8.1")
    if [[ " ${UNSUPPORTED_PHP_VERSIONS[*]} " == *" ${DDEV_PHP_VERSION} "* ]]; then
      echo "FrankenPHP is not supported for PHP version ${DDEV_PHP_VERSION}."
      echo "Please upgrade your project to at least PHP 8.2 to use FrankenPHP."
      echo "Run 'ddev config --php-version=8.2' to upgrade your PHP version."
      exit 2
    fi
  - |
    #ddev-description:Removing old files
    files=(
      "${DDEV_APPROOT}/.ddev/commands/host/xdebug"
      "${DDEV_APPROOT}/.ddev/php/docker-php-ext-xdebug.ini"
      "${DDEV_APPROOT}/.ddev/frankenphp/Caddyfile"
      "${DDEV_APPROOT}/.ddev/commands/frankenphp/php"
      "${DDEV_APPROOT}/.ddev/frankenphp/Dockerfile"
      "${DDEV_APPROOT}/.ddev/web-build/prepend.Dockerfile.frankenphp"
    )
    for file in "${files[@]}"; do
      if [ -f "${file}" ]; then
        if grep -q '#ddev-generated' "${file}"; then
          rm -f "${file}"
        else
          echo "${file} needs to be removed but has been modified by the user. Please check it and remove it"
          exit 2
        fi
      fi
    done
  - |
    #ddev-description:Checking for old configuration in .ddev/.env.web
    if grep -q 'FRANKENPHP_DEBIAN_CODENAME=' "${DDEV_APPROOT}/.ddev/.env.web" 2>/dev/null; then
      echo "You have FRANKENPHP_DEBIAN_CODENAME set in your .ddev/.env.web which is no longer needed."
      echo "Remove it from '${DDEV_APPROOT}/.ddev/.env.web' or delete the file and try again."
      exit 2
    fi
    if grep -q 'FRANKENPHP_DEFAULT_EXTENSIONS=' "${DDEV_APPROOT}/.ddev/.env.web" 2>/dev/null; then
      echo "You have FRANKENPHP_DEFAULT_EXTENSIONS set in your .ddev/.env.web which is no longer needed."
      echo "Remove it from '${DDEV_APPROOT}/.ddev/.env.web' or delete the file and try again."
      exit 2
    fi
    if grep -q 'FRANKENPHP_CUSTOM_EXTENSIONS=' "${DDEV_APPROOT}/.ddev/.env.web" 2>/dev/null; then
      echo "You have FRANKENPHP_CUSTOM_EXTENSIONS set in your .ddev/.env.web which is no longer needed."
      echo "Remove it from '${DDEV_APPROOT}/.ddev/.env.web' or delete the file and try again."
      echo "Extra PHP extensions should now be installed via webimage_extra_packages, see https://github.com/ddev/ddev-frankenphp"
      echo "For example, to install the grpc extension, add 'php-zts-grpc' to webimage_extra_packages in your .ddev/config.yaml"
      exit 2
    fi

ddev_version_constraint: '>= v1.24.10'
